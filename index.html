<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hucha Digital Completa</title>

  <!-- Fuente Rubik Bold -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@700&display=swap" rel="stylesheet" />

  <style>
    body {
      margin:0; padding:0;
      font-family: 'Rubik', sans-serif;
      background: white;
      color: black;
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden;
    }
    body.dark {
      background: #121212;
      color: #eee;
    }

    .wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      width: 100%;
      padding: 1rem;
      box-sizing: border-box;
    }

    /* Inputs y contenedores */
    .goal-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      width: 80%;
      max-width: 320px;
      margin-bottom: 8px;
    }
    .goal-label {
      font-weight: 700;
      font-size: 1.2em;
      user-select:none;
    }
    #goalInput {
      font-size: 1.2em;
      padding: 5px 8px;
      width: 120px;
      border: 2px solid black;
      border-radius: 6px;
      background: transparent;
      color: inherit;
      outline: none;
    }
    .goal-bar-bg {
      width: 80%;
      max-width: 320px;
      height: 16px;
      background: #ddd;
      border-radius: 12px;
      border: 2px solid black;
      margin: 0 auto 15px;
      overflow: hidden;
    }
    .goal-bar-fill {
      height: 100%;
      background: green;
      width: 0%;
      transition: width 0.6s ease;
    }

    #goalName {
      font-size: 1.5em;
      font-weight: 700;
      border: 2px solid black;
      border-radius: 6px;
      padding: 5px 10px;
      width: 80%;
      max-width: 320px;
      margin-bottom: 5px;
      background: transparent;
      color: inherit;
      outline: none;
      text-align: center;
    }

    /* Texto e iconos */
    #counter {
      font-size: 3em;
      margin-bottom: 15px;
      user-select: none;
    }
    .pig {
      font-size: 6em;
      border: 5px solid black;
      border-radius: 50%;
      padding: 20px;
      margin-bottom: 20px;
      user-select: none;
      color: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Botones */
    #toggleAdd {
      font-weight: 700;
      font-size: 1.2em;
      margin-bottom: 15px;
      padding: 10px 25px;
      border: 2px solid black;
      background: none;
      cursor: pointer;
      color: inherit;
      max-width: 320px;
      transition: background-color 0.3s, color 0.3s;
    }
    #toggleAdd:hover {
      background-color: black;
      color: white;
    }
    #addButtons {
      display: none;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      max-width: 320px;
      margin-bottom: 15px;
    }
    #addButtons button, #addCustomBtn, #editBtn, #resetBtn {
      padding: 10px 20px;
      font-size: 1em;
      border: 2px solid black;
      background: none;
      cursor: pointer;
      font-weight: 700;
      color: inherit;
      border-radius: 6px;
      transition: background-color 0.3s, color 0.3s;
    }
    #addButtons button:hover, #addCustomBtn:hover, #editBtn:hover, #resetBtn:hover {
      background-color: black;
      color: white;
    }
    #custom {
      padding: 10px;
      font-size: 1em;
      width: 80px;
      text-align: center;
      border: 2px solid black;
      background: transparent;
      color: inherit;
      border-radius: 6px;
    }

    /* Iconos flotantes */
    .settings-icon, .piggy-menu-icon {
      position: fixed;
      font-size: 2em;
      cursor: pointer;
      user-select: none;
      color: inherit;
      z-index: 100;
    }
    .settings-icon {
      bottom: 20px;
      right: 20px;
    }
    .piggy-menu-icon {
      top: 20px;
      left: 20px;
    }

    /* Men√∫ ajustes */
    #settingsMenu {
      position: fixed;
      bottom: 70px;
      right: 20px;
      background: white;
      border: 2px solid black;
      padding: 12px;
      display: none;
      flex-direction: column;
      gap: 8px;
      max-width: 280px;
      color: black;
      border-radius: 8px;
      font-weight: 700;
      user-select:none;
      z-index: 99;
    }
    body.dark #settingsMenu {
      background: #222;
      color: white;
      border-color: white;
    }
    #settingsMenu button {
      padding: 6px 10px;
      font-size: 1em;
      cursor: pointer;
      background: none;
      border: 1px solid currentColor;
      color: inherit;
      border-radius: 6px;
      transition: background-color 0.3s, color 0.3s;
    }
    #settingsMenu button:hover {
      background-color: currentColor;
      color: inherit;
      filter: invert(1);
    }
    #settingsMenu hr {
      border-color: currentColor;
      margin: 8px 0;
      border-style: solid;
      border-width: 1px 0 0 0;
    }

    /* Men√∫ huchas */
    #piggyMenu {
      position: fixed;
      top: 60px;
      left: 20px;
      background: white;
      border: 2px solid black;
      padding: 12px;
      display: none;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
      width: 220px;
      border-radius: 8px;
      color: black;
      font-weight: 700;
      user-select:none;
      z-index: 99;
    }
    body.dark #piggyMenu {
      background: #222;
      color: white;
      border-color: white;
    }
    #piggyMenu button {
      background: none;
      border: 1px solid currentColor;
      padding: 8px;
      cursor: pointer;
      color: inherit;
      border-radius: 6px;
      transition: background-color 0.3s, color 0.3s;
    }
    #piggyMenu button:hover {
      background-color: currentColor;
      color: inherit;
      filter: invert(1);
    }

    /* Historial */
    #historyBox {
      position: fixed;
      top: 20px;
      right: 20px;
      max-height: 320px;
      width: 280px;
      overflow-y: auto;
      background: rgba(255,255,255,0.95);
      border: 2px solid black;
      padding: 12px;
      font-size: 0.9em;
      display: none;
      border-radius: 8px;
      color: black;
      font-weight: 700;
      user-select:none;
      z-index: 98;
    }
    body.dark #historyBox {
      background: #222;
      color: white;
      border-color: white;
    }

    /* Gr√°fico */
    #progressChart {
      max-width: 90vw;
      max-height: 250px;
      margin: 10px auto 0;
      display: none;
      user-select:none;
      z-index: 98;
    }
  </style>
</head>
<body>

  <!-- Iconos flotantes -->
  <div class="piggy-menu-icon" title="Men√∫ de huchas" onclick="togglePiggyMenu()">‚ò∞</div>
  <div class="settings-icon" title="Ajustes" onclick="toggleSettings()">‚öôÔ∏è</div>

  <!-- Contenedor principal -->
  <div class="wrapper">

    <!-- Meta -->
    <div class="goal-container">
      <label for="goalInput" class="goal-label">üéØ Meta (‚Ç¨):</label>
      <input id="goalInput" type="number" min="0" step="0.01" placeholder="Ej: 100" />
    </div>

    <!-- Barra progreso -->
    <div class="goal-bar-bg"><div id="goalFill" class="goal-bar-fill"></div></div>

    <!-- Nombre editable -->
    <input id="goalName" type="text" placeholder="Nombre del ahorro (ej. Viaje)" maxlength="30" />

    <!-- Contador y cerdito -->
    <div id="counter">‚Ç¨0.00</div>
    <div class="pig">üê∑</div>

    <!-- Bot√≥n a√±adir -->
    <button id="toggleAdd">Meter a la hucha</button>

    <!-- Botones a√±adir cantidades -->
    <div id="addButtons">
      <button data-amount="1">+1‚Ç¨</button>
      <button data-amount="5">+5‚Ç¨</button>
      <button data-amount="10">+10‚Ç¨</button>
      <input id="custom" type="number" placeholder="Otra" min="0.01" step="0.01" />
      <button id="addCustomBtn">A√±adir</button>
      <button id="editBtn">Editar total</button>
      <button id="resetBtn" style="color:red;">Reiniciar</button>
    </div>

    <!-- Gr√°fico -->
    <canvas id="progressChart"></canvas>
  </div>

  <!-- Men√∫ ajustes -->
  <div id="settingsMenu">
    <div>üéµ Sonido:</div>
    <button data-sound="coin">Sonido 1</button>
    <button data-sound="bell">Sonido 2</button>
    <button data-sound="mute">Silencio</button>
    <hr />
    <div>üåì Modo:</div>
    <button id="toggleDarkMode">Alternar modo oscuro</button>
    <hr />
    <div>üìú Historial:</div>
    <button id="showHistory">Ver historial</button>
    <button id="showProgress">Ver progreso</button>
  </div>

  <!-- Men√∫ huchas -->
  <div id="piggyMenu">
    <div><strong>Huchas:</strong></div>
    <div id="piggyList"></div>
    <button id="newPiggyBtn">‚ûï Nueva hucha</button>
    <button id="breakPiggyBtn" style="color:red;">üí• Romper hucha</button>
  </div>

  <!-- Historial -->
  <div id="historyBox"></div>

  <!-- Sonidos -->
  <audio id="soundCoin" src="https://actions.google.com/sounds/v1/coins/coin_drop.ogg" preload="auto"></audio>
  <audio id="soundBell" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Elementos DOM
    const counter = document.getElementById('counter');
    const toggleAddBtn = document.getElementById('toggleAdd');
    const addButtonsDiv = document.getElementById('addButtons');
    const customInput = document.getElementById('custom');
    const addCustomBtn = document.getElementById('addCustomBtn');
    const editBtn = document.getElementById('editBtn');
    const resetBtn = document.getElementById('resetBtn');
    const goalInput = document.getElementById('goalInput');
    const goalFill = document.getElementById('goalFill');
    const goalName = document.getElementById('goalName');
    const settingsMenu = document.getElementById('settingsMenu');
    const piggyMenu = document.getElementById('piggyMenu');
    const piggyList = document.getElementById('piggyList');
    const newPiggyBtn = document.getElementById('newPiggyBtn');
    const breakPiggyBtn = document.getElementById('breakPiggyBtn');
    const historyBox = document.getElementById('historyBox');
    const toggleDarkModeBtn = document.getElementById('toggleDarkMode');
    const showHistoryBtn = document.getElementById('showHistory');
    const showProgressBtn = document.getElementById('showProgress');

    const soundCoin = document.getElementById('soundCoin');
    const soundBell = document.getElementById('soundBell');

    // Estado
    let huchas = [];
    let currentPiggyIndex = 0;
    let total = 0;
    let goal = 0;
    let soundChoice = 'coin'; // 'coin', 'bell', 'mute'
    let history = [];
    let chart = null;

    // --- UTILIDADES ---

    function saveToStorage() {
      localStorage.setItem('huchas', JSON.stringify(huchas));
      localStorage.setItem('currentPiggyIndex', currentPiggyIndex);
      localStorage.setItem('soundChoice', soundChoice);
      localStorage.setItem('darkMode', document.body.classList.contains('dark'));
      localStorage.setItem('history', JSON.stringify(history));
    }

    function loadFromStorage() {
      const huchasLS = localStorage.getItem('huchas');
      huchas = huchasLS ? JSON.parse(huchasLS) : [];
      if (huchas.length === 0) {
        // Si no hay huchas, crear una principal inicial
        huchas.push(createNewPiggy("Hucha principal"));
      }
      const idx = localStorage.getItem('currentPiggyIndex');
      currentPiggyIndex = idx !== null ? parseInt(idx, 10) : 0;
      soundChoice = localStorage.getItem('soundChoice') || 'coin';
      const darkModeLS = localStorage.getItem('darkMode');
      if(darkModeLS === 'true'){
        document.body.classList.add('dark');
      } else {
        document.body.classList.remove('dark');
      }
      const historyLS = localStorage.getItem('history');
      history = historyLS ? JSON.parse(historyLS) : [];
    }

    function createNewPiggy(name) {
      return {
        name,
        total: 0,
        goal: 0,
        history: []
      };
    }

    function playSound() {
      if(soundChoice === 'mute') return;
      if(soundChoice === 'coin') {
        soundCoin.currentTime = 0;
        soundCoin.play();
      } else if(soundChoice === 'bell') {
        soundBell.currentTime = 0;
        soundBell.play();
      }
    }

    // Actualiza UI con datos de la hucha actual
    function updateUI() {
      if (!huchas[currentPiggyIndex]) return;
      const piggy = huchas[currentPiggyIndex];
      total = piggy.total;
      goal = piggy.goal;

      counter.textContent = `‚Ç¨${total.toFixed(2)}`;
      goalInput.value = goal > 0 ? goal : '';
      goalName.value = piggy.name;

      if (goal > 0) {
        const pct = Math.min((total / goal) * 100, 100);
        goalFill.style.width = pct + '%';
      } else {
        goalFill.style.width = '0%';
      }

      updatePiggyList();
      saveToStorage();
    }

    // Actualiza lista de huchas en men√∫
    function updatePiggyList() {
      piggyList.innerHTML = '';
      huchas.forEach((p, i) => {
        const btn = document.createElement('button');
        btn.textContent = (i === currentPiggyIndex ? "üëâ " : "") + p.name;
        btn.onclick = () => {
          currentPiggyIndex = i;
          updateUI();
          hidePiggyMenu();
          hideAddButtons();
        };
        piggyList.appendChild(btn);
      });
    }

    // Mostrar/ocultar men√∫s
    function toggleSettings() {
      if(settingsMenu.style.display === 'flex'){
        settingsMenu.style.display = 'none';
      } else {
        settingsMenu.style.display = 'flex';
        piggyMenu.style.display = 'none';
        historyBox.style.display = 'none';
        hideAddButtons();
      }
    }
    function togglePiggyMenu() {
      if(piggyMenu.style.display === 'flex'){
        piggyMenu.style.display = 'none';
      } else {
        piggyMenu.style.display = 'flex';
        settingsMenu.style.display = 'none';
        historyBox.style.display = 'none';
        hideAddButtons();
      }
    }
    function hideAddButtons() {
      addButtonsDiv.style.display = 'none';
      toggleAddBtn.textContent = 'Meter a la hucha';
    }

    // A√±adir cantidad a la hucha actual
    function addAmount(amount) {
      if(amount <= 0) return;
      const piggy = huchas[currentPiggyIndex];
      piggy.total += amount;
      // A√±adir al historial de esa hucha
      piggy.history.push({ date: new Date().toISOString(), amount: amount });
      total = piggy.total;
      updateUI();
      playSound();
      saveToStorage();
    }

    // Editar total
    function editTotal() {
      const piggy = huchas[currentPiggyIndex];
      const val = prompt('Nuevo total (‚Ç¨):', piggy.total);
      const num = parseFloat(val);
      if (!isNaN(num) && num >= 0) {
        piggy.total = num;
        piggy.history.push({ date: new Date().toISOString(), amount: 0, note: "Edici√≥n total" });
        updateUI();
        saveToStorage();
      }
    }

    // Reiniciar hucha actual
    function resetPiggy() {
      if(confirm(`¬øReiniciar la hucha "${huchas[currentPiggyIndex].name}"?`)){
        const piggy = huchas[currentPiggyIndex];
        piggy.total = 0;
        piggy.history.push({ date: new Date().toISOString(), amount: 0, note: "Reinicio" });
        updateUI();
        saveToStorage();
      }
    }

    // Crear nueva hucha con nombre autom√°tico
    function createNewPiggyWithName() {
      let baseName = "Hucha ";
      // Buscar n√∫mero libre
      let num = 1;
      const existingNames = huchas.map(p => p.name);
      while(existingNames.includes(baseName + num)){
        num++;
      }
      const newName = baseName + num;
      const newPiggy = createNewPiggy(newName);
      huchas.push(newPiggy);
      currentPiggyIndex = huchas.length -1;
      updateUI();
      hidePiggyMenu();
    }

    // Romper hucha actual
    function breakCurrentPiggy() {
      if(huchas.length === 1){
        alert("No puedes romper la √∫nica hucha que tienes.");
        return;
      }
      if(confirm(`¬øSeguro que quieres romper la hucha "${huchas[currentPiggyIndex].name}"? Esta acci√≥n no se puede deshacer.`)){
        huchas.splice(currentPiggyIndex,1);
        if(currentPiggyIndex >= huchas.length) currentPiggyIndex = huchas.length -1;
        updateUI();
        hidePiggyMenu();
      }
    }

    // Cambios meta o nombre
    goalInput.oninput = () => {
      let val = parseFloat(goalInput.value);
      if(isNaN(val) || val < 0) val = 0;
      huchas[currentPiggyIndex].goal = val;
      updateUI();
      saveToStorage();
    };
    goalName.oninput = () => {
      huchas[currentPiggyIndex].name = goalName.value.trim().slice(0,30);
      updateUI();
      saveToStorage();
    };

    // Bot√≥n a√±adir toggler
    toggleAddBtn.onclick = () => {
      if(addButtonsDiv.style.display === 'flex'){
        addButtonsDiv.style.display = 'none';
        toggleAddBtn.textContent = 'Meter a la hucha';
      } else {
        addButtonsDiv.style.display = 'flex';
        toggleAddBtn.textContent = 'Cerrar';
      }
      // Cerrar otros men√∫s si abiertos
      settingsMenu.style.display = 'none';
      piggyMenu.style.display = 'none';
      historyBox.style.display = 'none';
    };

    // Botones a√±adir cantidades predefinidas
    document.querySelectorAll('#addButtons button[data-amount]').forEach(btn=>{
      btn.onclick = () => {
        const amount = parseFloat(btn.getAttribute('data-amount'));
        addAmount(amount);
      };
    });

    // Bot√≥n a√±adir cantidad custom
    addCustomBtn.onclick = () => {
      const val = parseFloat(customInput.value);
      if(!isNaN(val) && val > 0){
        addAmount(val);
        customInput.value = '';
      }
    };

    // Editar total
    editBtn.onclick = editTotal;

    // Resetear hucha
    resetBtn.onclick = resetPiggy;

    // Botones men√∫ huchas
    newPiggyBtn.onclick = createNewPiggyWithName;
    breakPiggyBtn.onclick = breakCurrentPiggy;

    // Sonidos men√∫ ajustes
    settingsMenu.querySelectorAll('button[data-sound]').forEach(btn=>{
      btn.onclick = () => {
        soundChoice = btn.getAttribute('data-sound');
        saveToStorage();
      };
    });

    // Modo oscuro toggle
    toggleDarkModeBtn.onclick = () => {
      document.body.classList.toggle('dark');
      saveToStorage();
    };

    // Mostrar historial
    showHistoryBtn.onclick = () => {
      if(historyBox.style.display === 'block'){
        historyBox.style.display = 'none';
      } else {
        updateHistoryBox();
        historyBox.style.display = 'block';
        settingsMenu.style.display = 'none';
        piggyMenu.style.display = 'none';
        hideAddButtons();
      }
    };

    // Mostrar gr√°fico progreso
    showProgressBtn.onclick = () => {
      if(chart){
        if(chart.canvas.style.display === 'block'){
          chart.canvas.style.display = 'none';
        } else {
          updateChart();
          chart.canvas.style.display = 'block';
          settingsMenu.style.display = 'none';
          piggyMenu.style.display = 'none';
          hideAddButtons();
        }
      }
    };

    // Actualizar historial para mostrar
    function updateHistoryBox(){
      const piggy = huchas[currentPiggyIndex];
      if(!piggy) return;
      if(piggy.history.length === 0){
        historyBox.textContent = "No hay movimientos a√∫n.";
        return;
      }
      let html = `<strong>Historial de "${piggy.name}":</strong><br><br>`;
      piggy.history.slice().reverse().forEach(entry=>{
        const date = new Date(entry.date).toLocaleString();
        const amount = entry.amount !== 0 ? (entry.amount > 0 ? `+‚Ç¨${entry.amount.toFixed(2)}` : `-‚Ç¨${Math.abs(entry.amount).toFixed(2)}`) : "";
        const note = entry.note ? ` (${entry.note})` : "";
        html += `${date} ${amount}${note}<br>`;
      });
      historyBox.innerHTML = html;
    }

    // Gr√°fico progreso con Chart.js
    function updateChart(){
      const piggy = huchas[currentPiggyIndex];
      if(!piggy) return;

      const labels = [];
      const dataPoints = [];
      let accumulated = 0;

      piggy.history.forEach(entry => {
        labels.push(new Date(entry.date).toLocaleDateString());
        accumulated += entry.amount;
        dataPoints.push(accumulated);
      });

      if(chart) chart.destroy();

      const ctx = document.getElementById('progressChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: `Progreso de "${piggy.name}"`,
            data: dataPoints,
            borderColor: 'green',
            backgroundColor: 'rgba(0,128,0,0.2)',
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointHoverRadius: 6,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              labels: {
                color: document.body.classList.contains('dark') ? 'white' : 'black'
              }
            }
          }
        }
      });
    }

    // Inicializaci√≥n
    loadFromStorage();
    updateUI();

  </script>
</body>
</html>
