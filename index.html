<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hucha Digital - Multiobjetivos</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@700&display=swap');
    body {
      margin: 0;
      padding: 0;
      font-family: 'Rubik', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      position: relative;
      background: white;
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: #121212;
      color: white;
    }
    .goal-container {
      width: 80%;
      margin-bottom: 10px;
    }
    .goal-bar-bg {
      width: 100%;
      height: 20px;
      background: #ddd;
      border: 2px solid black;
      border-radius: 10px;
      overflow: hidden;
    }
    .goal-bar-fill {
      height: 100%;
      background: green;
      width: 0%;
      transition: width 0.5s ease;
    }
    .goal-input {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }
    #goalName {
      font-size: 1.5em;
      font-weight: 700;
      border: 2px solid black;
      padding: 5px 10px;
      border-radius: 5px;
      width: 80%;
      text-align: center;
      margin-bottom: 5px;
      outline: none;
      background: transparent;
      color: inherit;
    }
    .counter {
      font-size: 3em;
      margin-bottom: 10px;
    }
    .pig {
      font-size: 6em;
      border: 5px solid black;
      border-radius: 50%;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 1em;
      border: 2px solid black;
      background: none;
      cursor: pointer;
      font-weight: bold;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    button:hover {
      background-color: black;
      color: white;
    }
    input[type=number] {
      padding: 10px;
      font-size: 1em;
      width: 100px;
      text-align: center;
      border: 2px solid black;
      background: transparent;
      color: inherit;
    }
    .settings-icon {
      position: absolute;
      bottom: 20px;
      right: 20px;
      font-size: 1.5em;
      cursor: pointer;
      user-select: none;
    }
    .settings-menu {
      position: absolute;
      bottom: 60px;
      right: 20px;
      background: white;
      border: 2px solid black;
      padding: 10px;
      display: none;
      flex-direction: column;
      gap: 5px;
      z-index: 10;
      max-width: 280px;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark .settings-menu {
      background: #222;
      color: white;
      border-color: white;
    }
    .settings-menu button {
      padding: 5px 10px;
      font-size: 0.9em;
      color: inherit;
      border: 1px solid currentColor;
      background: none;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
    }
    .settings-menu button:hover {
      background-color: currentColor;
      color: inherit;
      filter: invert(1);
    }
    .history {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.95);
      border: 2px solid black;
      padding: 10px;
      display: none;
      max-height: 300px;
      overflow-y: auto;
      z-index: 10;
      width: 90vw;
      max-width: 400px;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark .history {
      background: #222;
      color: white;
      border-color: white;
    }
    /* Menu desplegable de huchas */
    .piggy-menu-icon {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 2em;
      cursor: pointer;
      user-select: none;
      color: black;
      transition: color 0.3s;
    }
    body.dark .piggy-menu-icon {
      color: white;
    }
    .piggy-menu {
      position: absolute;
      top: 50px;
      left: 10px;
      background: white;
      border: 2px solid black;
      padding: 10px;
      display: none;
      flex-direction: column;
      gap: 5px;
      z-index: 20;
      max-height: 300px;
      overflow-y: auto;
      width: 200px;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark .piggy-menu {
      background: #222;
      color: white;
      border-color: white;
    }
    .piggy-menu button {
      background: none;
      border: 1px solid currentColor;
      padding: 8px;
      cursor: pointer;
      text-align: left;
      font-weight: bold;
      color: inherit;
      transition: background-color 0.3s, color 0.3s;
    }
    .piggy-menu button:hover {
      background-color: currentColor;
      color: inherit;
      filter: invert(1);
    }
    #progressChart {
      max-width: 90vw;
      max-height: 250px;
      margin: 10px auto 0;
      display: none;
    }
  </style>
</head>
<body>
  <div class="piggy-menu-icon" title="Men√∫ de huchas" onclick="togglePiggyMenu()">‚ò∞</div>
  <div class="piggy-menu" id="piggyMenu">
    <div id="piggyList"></div>
    <button onclick="addNewPiggy()">+ A√±adir nueva hucha</button>
  </div>

  <div class="goal-container">
    <div class="goal-bar-bg">
      <div class="goal-bar-fill" id="goalFill"></div>
    </div>
    <div class="goal-input">
      <input id="goal" type="number" placeholder="Meta (‚Ç¨)" />
      <button onclick="setGoal()">Guardar meta</button>
    </div>
  </div>

  <input id="goalName" type="text" placeholder="Nombre del ahorro (ej. Viaje)" maxlength="30" />
  <div class="counter" id="counter">‚Ç¨0.00</div>
  <div class="pig">üê∑</div>
  <div class="buttons">
    <button onclick="addAmount(1)">+1‚Ç¨</button>
    <button onclick="addAmount(5)">+5‚Ç¨</button>
    <button onclick="addAmount(10)">+10‚Ç¨</button>
    <input id="custom" type="number" placeholder="Otra" />
    <button onclick="addCustom()">A√±adir</button>
    <button onclick="editAmount()">Editar</button>
    <button onclick="resetCounter()" style="color: red;">Reiniciar</button>
  </div>

  <div class="settings-icon" onclick="toggleSettings()">‚öôÔ∏è</div>
  <div class="settings-menu" id="settingsMenu">
    <strong>üéµ Sonido:</strong>
    <button onclick="setSound('coin')">Sonido 1</button>
    <button onclick="setSound('bell')">Sonido 2</button>
    <button onclick="setSound('none')">Silencio</button>
    <hr>
    <strong>üåì Modo:</strong>
    <button onclick="toggleDarkMode()">Alternar modo oscuro</button>
    <hr>
    <strong>üìú Historial:</strong>
    <button onclick="toggleHistory()">Ver historial</button>
    <button onclick="toggleProgress()">Ver progreso</button>
  </div>

  <div class="history" id="historyBox"></div>
  <canvas id="progressChart"></canvas>

  <audio id="sound-coin" src="https://cdn.pixabay.com/audio/2022/03/15/audio_cfc4f0b55b.mp3"></audio>
  <audio id="sound-bell" src="https://cdn.pixabay.com/audio/2022/03/15/audio_9e0a778b3f.mp3"></audio>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    // Datos guardados: objeto con m√∫ltiples huchas
    // Cada hucha tiene: name, total, goal, history (array de {date, amount}), sound, dark
    let piggies = JSON.parse(localStorage.getItem('piggies')) || {};

    // ID de la hucha actual
    let currentPiggyId = localStorage.getItem('currentPiggyId') || null;

    // Referencias DOM
    const counter = document.getElementById('counter');
    const goalFill = document.getElementById('goalFill');
    const settingsMenu = document.getElementById('settingsMenu');
    const goalNameInput = document.getElementById('goalName');
    const historyBox = document.getElementById('historyBox');
    const piggyMenu = document.getElementById('piggyMenu');
    const piggyList = document.getElementById('piggyList');
    const progressChart = document.getElementById('progressChart');
    let chartInstance = null;

    // Iniciar app
    if (!currentPiggyId || !piggies[currentPiggyId]) {
      // Si no hay huchas, creamos una por defecto
      currentPiggyId = 'default';
      piggies[currentPiggyId] = {
        name: 'Hucha principal',
        total: 0,
        goal: 0,
        history: [],
        sound: 'coin',
        dark: false
      };
      savePiggies();
    }

    // Guardar en localStorage
    function savePiggies() {
      localStorage.setItem('piggies', JSON.stringify(piggies));
      localStorage.setItem('currentPiggyId', currentPiggyId);
    }

    // Cambiar hucha actual
    function setCurrentPiggy(id) {
      if (piggies[id]) {
        currentPiggyId = id;
        savePiggies();
        hideHistory();
        hideProgress();
        updateUI();
        togglePiggyMenu(false);
        if (piggies[currentPiggyId].dark) {
          document.body.classList.add('dark');
        } else {
          document.body.classList.remove('dark');
        }
      }
    }

    // Actualizar interfaz con datos de hucha actual
    function updateUI() {
      const piggy = piggies[currentPiggyId];
      counter.textContent = `‚Ç¨${piggy.total.toFixed(2)}`;
      goalFill.style.width = piggy.goal > 0 ? Math.min(100, (piggy.total / piggy.goal) * 100) + '%' : '0%';
      goalNameInput.value = piggy.name;
      if (piggy.goal > 0 && piggy.total >= piggy.goal) {
        confetti();
      }
    }

    // A√±adir cantidad al total y guardar en historial
    function addAmount(amount) {
      if (amount <= 0) return;
      const piggy = piggies[currentPiggyId];
      piggy.total += amount;
      piggy.history.push({ date: new Date().toISOString(), amount });
      savePiggies();
      updateUI();
      if (piggy.sound !== 'none') playSound(piggy.sound);
    }

    // A√±adir valor personalizado
    function addCustom() {
      const input = document.getElementById('custom');
      const value = parseFloat(input.value);
      if (!isNaN(value) && value > 0) {
        addAmount(value);
        input.value = '';
      }
    }

    // Editar total manualmente
    function editAmount() {
      const piggy = piggies[currentPiggyId];
      const newValue = prompt('Nuevo total (‚Ç¨):', piggy.total.toFixed(2));
      const value = parseFloat(newValue);
      if (!isNaN(value) && value >= 0) {
        piggy.total = value;
        savePiggies();
        updateUI();
      }
    }

    // Reiniciar hucha actual
    function resetCounter() {
      if (confirm('¬øReiniciar hucha?')) {
        const piggy = piggies[currentPiggyId];
        piggy.total = 0;
        piggy.history = [];
        savePiggies();
        updateUI();
        hideHistory();
        hideProgress();
      }
    }

    // Guardar meta
    function setGoal() {
      const input = document.getElementById('goal');
      const value = parseFloat(input.value);
      if (!isNaN(value) && value > 0) {
        piggies[currentPiggyId].goal = value;
        savePiggies();
        updateUI();
        input.value = '';
      }
    }

    // Guardar nombre hucha
    goalNameInput.addEventListener('input', () => {
      piggies[currentPiggyId].name = goalNameInput.value;
      savePiggies();
      updatePiggyList();
    });

    // Sonido
    function playSound(type) {
      if (type === 'coin') document.getElementById('sound-coin').play();
      if (type === 'bell') document.getElementById('sound-bell').play();
    }
    function setSound(type) {
      piggies[currentPiggyId].sound = type;
      savePiggies();
      toggleSettings();
    }

    // Modo oscuro
    function toggleDarkMode() {
      const piggy = piggies[currentPiggyId];
      piggy.dark = !piggy.dark;
      savePiggies();
      if (piggy.dark) document.body.classList.add('dark');
      else document.body.classList.remove('dark');
    }

    // Mostrar/Ocultar men√∫ de ajustes
    function toggleSettings() {
      settingsMenu.style.display = settingsMenu.style.display === 'flex' ? 'none' : 'flex';
    }

    // Men√∫ de huchas
    function togglePiggyMenu(force) {
      if (typeof force === 'boolean') {
        piggyMenu.style.display = force ? 'flex' : 'none';
      } else {
        piggyMenu.style.display = piggyMenu.style.display === 'flex' ? 'none' : 'flex';
      }
    }

    // Actualizar lista de huchas en men√∫
    function updatePiggyList() {
      piggyList.innerHTML = '';
      for (const id in piggies) {
        const btn = document.createElement('button');
        btn.textContent = piggies[id].name || '(sin nombre)';
        if (id === currentPiggyId) btn.style.fontWeight = '900';
        btn.onclick = () => setCurrentPiggy(id);
        piggyList.appendChild(btn);
      }
    }

    // A√±adir nueva hucha
    function addNewPiggy() {
      const name = prompt('Nombre para la nueva hucha:', 'Nueva Hucha');
      if (!name) return;
      // Generar ID √∫nico
      const id = 'piggy_' + Date.now();
      piggies[id] = {
        name: name,
        total: 0,
        goal: 0,
        history: [],
        sound: 'coin',
        dark: false
      };
      savePiggies();
      updatePiggyList();
      setCurrentPiggy(id);
      togglePiggyMenu(false);
    }

    // Historial
    function toggleHistory() {
      if (historyBox.style.display === 'block') {
        historyBox.style.display = 'none';
      } else {
        const piggy = piggies[currentPiggyId];
        historyBox.innerHTML = piggy.history.length
          ? piggy.history
              .slice()
              .reverse()
              .map(h => `+‚Ç¨${h.amount.toFixed(2)} - ${new Date(h.date).toLocaleString()}`)
              .join('<br>')
          : 'No hay movimientos a√∫n.';
        historyBox.style.display = 'block';
        hideProgress();
      }
    }
    function hideHistory() {
      historyBox.style.display = 'none';
    }

    // Gr√°fico con Chart.js
    function toggleProgress() {
      if (progressChart.style.display === 'block') {
        hideProgress();
      } else {
        showProgress();
      }
      hideHistory();
    }
    function hideProgress() {
      progressChart.style.display = 'none';
      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }
    }
    function showProgress() {
      const piggy = piggies[currentPiggyId];
      if (!piggy.history.length) {
        alert('No hay datos para mostrar en el gr√°fico.');
        return;
      }
      progressChart.style.display = 'block';

      // Preparar datos para gr√°fico
      // Sumamos acumulado por fecha
      const dataMap = {};
      piggy.history.forEach(h => {
        const dateStr = new Date(h.date).toLocaleDateString();
        dataMap[dateStr] = (dataMap[dateStr] || 0) + h.amount;
      });
      const dates = Object.keys(dataMap).sort((a,b) => new Date(a) - new Date(b));
      let cumulative = 0;
      const cumData = dates.map(d => {
        cumulative += dataMap[d];
        return cumulative;
      });

      // Crear gr√°fico
      const ctx = progressChart.getContext('2d');
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: `Ahorro - ${piggy.name}`,
            data: cumData,
            borderColor: 'green',
            backgroundColor: 'rgba(0, 128, 0, 0.2)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 7,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // Inicializaci√≥n
    updatePiggyList();
    updateUI();
    if (piggies[currentPiggyId].dark) document.body.classList.add('dark');
  </script>
</body>
</html>
