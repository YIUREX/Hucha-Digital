<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hucha Digital Completa</title>

  <!-- Fuente Rubik Bold -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@700&display=swap" rel="stylesheet" />

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Rubik', sans-serif;
      background: white;
      color: black;
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden;
    }
    body.dark {
      background: #121212;
      color: #eee;
    }

    .wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1rem;
      box-sizing: border-box;
      width: 100%;
    }

    .goal-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      width: 80%;
      max-width: 320px;
      margin-bottom: 8px;
    }
    .goal-label {
      font-weight: 700;
      font-size: 1.2em;
      user-select: none;
    }
    #goalInput {
      font-size: 1.2em;
      padding: 5px 8px;
      width: 120px;
      border: 2px solid black;
      border-radius: 6px;
      background: transparent;
      color: inherit;
      outline: none;
    }
    .goal-bar-bg {
      width: 80%;
      max-width: 320px;
      height: 16px;
      background: #ddd;
      border-radius: 12px;
      border: 2px solid black;
      margin: 0 auto 15px;
      overflow: hidden;
    }
    .goal-bar-fill {
      height: 100%;
      background: green;
      width: 0%;
      transition: width 0.6s ease;
    }

    #goalName {
      font-size: 1.5em;
      font-weight: 700;
      border: 2px solid black;
      border-radius: 6px;
      padding: 5px 10px;
      width: 80%;
      max-width: 320px;
      margin-bottom: 5px;
      background: transparent;
      color: inherit;
      outline: none;
      text-align: center;
    }

    #counter {
      font-size: 3em;
      margin-bottom: 15px;
      user-select: none;
    }
    .pig {
      font-size: 6em;
      border: 5px solid black;
      border-radius: 50%;
      padding: 20px;
      margin-bottom: 20px;
      user-select: none;
      color: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #toggleAdd {
      font-weight: 700;
      font-size: 1.2em;
      margin-bottom: 15px;
      padding: 10px 25px;
      border: 2px solid black;
      background: none;
      cursor: pointer;
      color: inherit;
      max-width: 320px;
      transition: background-color 0.3s, color 0.3s;
    }
    #toggleAdd:hover {
      background-color: black;
      color: white;
    }

    #addButtons {
      display: none;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      max-width: 320px;
      margin-bottom: 15px;
    }
    #addButtons button, #addCustomBtn, #editBtn, #resetBtn {
      padding: 10px 20px;
      font-size: 1em;
      border: 2px solid black;
      background: none;
      cursor: pointer;
      font-weight: 700;
      color: inherit;
      transition: background-color 0.3s, color 0.3s;
      border-radius: 6px;
    }
    #addButtons button:hover, #addCustomBtn:hover, #editBtn:hover, #resetBtn:hover {
      background-color: black;
      color: white;
    }
    #custom {
      padding: 10px;
      font-size: 1em;
      width: 80px;
      text-align: center;
      border: 2px solid black;
      background: transparent;
      color: inherit;
      border-radius: 6px;
      margin-right: 6px;
    }

    /* Iconos fijos sin c√≠rculo */
    .settings-icon, .piggy-menu-icon {
      position: fixed;
      font-size: 2em;
      cursor: pointer;
      user-select: none;
      color: inherit;
      z-index: 100;
      background: none;
      border: none;
      padding: 0;
    }
    .settings-icon {
      bottom: 20px;
      right: 20px;
    }
    .piggy-menu-icon {
      top: 20px;
      left: 20px;
    }

    /* Men√∫ ajustes */
    #settingsMenu {
      position: fixed;
      bottom: 70px;
      right: 20px;
      background: white;
      border: 2px solid black;
      padding: 12px;
      display: none;
      flex-direction: column;
      gap: 8px;
      max-width: 280px;
      color: black;
      border-radius: 8px;
      user-select: none;
      z-index: 101;
    }
    body.dark #settingsMenu {
      background: #222;
      color: white;
      border-color: white;
    }
    #settingsMenu strong {
      font-size: 1.1em;
      margin-top: 6px;
    }
    #settingsMenu button {
      padding: 6px 10px;
      font-size: 1em;
      cursor: pointer;
      background: none;
      border: 1px solid currentColor;
      color: inherit;
      font-weight: 700;
      border-radius: 6px;
      transition: background-color 0.3s, color 0.3s;
    }
    #settingsMenu button:hover {
      background-color: currentColor;
      color: inherit;
      filter: invert(1);
    }
    #settingsMenu hr {
      border-color: currentColor;
      margin: 8px 0;
      border-style: solid;
      border-width: 1px 0 0 0;
    }

    /* Men√∫ huchas */
    #piggyMenu {
      position: fixed;
      top: 60px;
      left: 20px;
      background: white;
      border: 2px solid black;
      padding: 12px;
      display: none;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
      width: 220px;
      border-radius: 8px;
      color: black;
      user-select: none;
      z-index: 101;
    }
    body.dark #piggyMenu {
      background: #222;
      color: white;
      border-color: white;
    }
    #piggyMenu button {
      background: none;
      border: 1px solid currentColor;
      padding: 8px;
      cursor: pointer;
      font-weight: 700;
      color: inherit;
      border-radius: 6px;
      transition: background-color 0.3s, color 0.3s;
    }
    #piggyMenu button:hover {
      background-color: currentColor;
      color: inherit;
      filter: invert(1);
    }

    /* Historial */
    #historyBox {
      position: fixed;
      top: 20px;
      right: 20px;
      max-height: 320px;
      width: 280px;
      overflow-y: auto;
      background: rgba(255,255,255,0.95);
      border: 2px solid black;
      padding: 12px;
      font-size: 0.9em;
      display: none;
      border-radius: 8px;
      color: black;
      user-select: none;
      z-index: 101;
    }
    body.dark #historyBox {
      background: #222;
      color: white;
      border-color: white;
    }

    /* Gr√°fico */
    #progressChart {
      max-width: 90vw;
      max-height: 250px;
      margin: 10px auto 0;
      display: none;
      user-select: none;
      border: 2px solid black;
      border-radius: 8px;
      background: white;
      z-index: 101;
    }
    body.dark #progressChart {
      background: #222;
      border-color: white;
    }
  </style>
</head>
<body>
  <!-- Iconos fijos -->
  <div class="piggy-menu-icon" title="Men√∫ de huchas" onclick="togglePiggyMenu()">‚ò∞</div>
  <div class="settings-icon" title="Ajustes" onclick="toggleSettings()">‚öôÔ∏è</div>

  <div class="wrapper">
    <div class="goal-container">
      <label for="goalInput" class="goal-label">üéØ Meta (‚Ç¨):</label>
      <input id="goalInput" type="number" min="0" step="0.01" placeholder="Ej: 100" />
    </div>

    <div class="goal-bar-bg"><div id="goalFill" class="goal-bar-fill"></div></div>

    <input id="goalName" type="text" placeholder="Nombre del ahorro (ej. Viaje)" maxlength="30" />

    <div id="counter">‚Ç¨0.00</div>
    <div class="pig">üê∑</div>

    <button id="toggleAdd">Meter a la hucha</button>

    <div id="addButtons">
      <button data-amount="1">+1‚Ç¨</button>
      <button data-amount="5">+5‚Ç¨</button>
      <button data-amount="10">+10‚Ç¨</button>
      <input id="custom" type="number" placeholder="Otra" min="0.01" step="0.01" />
      <button id="addCustomBtn">A√±adir</button>
      <button id="editBtn">Editar total</button>
      <button id="resetBtn" style="color:red;">Reiniciar</button>
    </div>

    <canvas id="progressChart"></canvas>
  </div>

  <!-- Men√∫ ajustes -->
  <div id="settingsMenu" aria-label="Men√∫ de Ajustes">
    <strong>üéµ Sonido:</strong>
    <button id="sound1Btn">Sonido 1</button>
    <button id="sound2Btn">Sonido 2</button>
    <button id="muteBtn">Silencio</button>

    <hr/>

    <strong>üåì Modo:</strong>
    <button id="toggleDarkModeBtn">Alternar modo oscuro</button>

    <hr/>

    <strong>üìú Historial:</strong>
    <button id="viewHistoryBtn">Ver historial</button>
    <button id="viewProgressBtn">Ver progreso</button>
  </div>

  <!-- Men√∫ huchas -->
  <div id="piggyMenu" aria-label="Men√∫ de Huchas">
    <!-- Aqu√≠ se mostrar√°n las huchas si a√±ades funcionalidad para varias -->
    <em>A√∫n no hay otras huchas.</em>
  </div>

  <!-- Historial -->
  <div id="historyBox" aria-label="Historial de movimientos">
    <strong>Historial:</strong>
    <ul id="historyList" style="padding-left:1.2em; margin-top:6px;"></ul>
  </div>

  <script>
    // Variables globales
    const counter = document.getElementById('counter');
    const toggleAddBtn = document.getElementById('toggleAdd');
    const addButtonsDiv = document.getElementById('addButtons');
    const customInput = document.getElementById('custom');
    const addCustomBtn = document.getElementById('addCustomBtn');
    const editBtn = document.getElementById('editBtn');
    const resetBtn = document.getElementById('resetBtn');
    const goalInput = document.getElementById('goalInput');
    const goalFill = document.getElementById('goalFill');
    const goalName = document.getElementById('goalName');
    const piggyMenuBtn = document.querySelector('.piggy-menu-icon');
    const settingsBtn = document.querySelector('.settings-icon');
    const settingsMenu = document.getElementById('settingsMenu');
    const piggyMenu = document.getElementById('piggyMenu');
    const historyBox = document.getElementById('historyBox');
    const historyList = document.getElementById('historyList');
    const progressChartEl = document.getElementById('progressChart');

    let total = 0;
    let goal = 0;
    let goalTitle = '';
    let history = [];
    let soundMode = 'sound1'; // sound1, sound2, mute
    let darkMode = false;
    let chart = null;

    // Sonidos
    const sound1 = new Audio('https://actions.google.com/sounds/v1/coins/coin_drop.ogg');
    const sound2 = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');

    // --- LOCAL STORAGE ---
    function loadStorage() {
      const data = localStorage.getItem('huchaData');
      if (data) {
        try {
          const obj = JSON.parse(data);
          total = obj.total || 0;
          goal = obj.goal || 0;
          goalTitle = obj.goalTitle || '';
          history = obj.history || [];
          soundMode = obj.soundMode || 'sound1';
          darkMode = obj.darkMode || false;
        } catch {
          total = 0; goal = 0; goalTitle = ''; history = [];
          soundMode = 'sound1';
          darkMode = false;
        }
      }
    }
    function saveStorage() {
      const obj = { total, goal, goalTitle, history, soundMode, darkMode };
      localStorage.setItem('huchaData', JSON.stringify(obj));
    }

    // --- UI UPDATE ---
    function updateUI() {
      counter.textContent = `‚Ç¨${total.toFixed(2)}`;
      goalInput.value = goal > 0 ? goal : '';
      goalName.value = goalTitle;

      if (goal > 0) {
        const pct = Math.min((total / goal) * 100, 100);
        goalFill.style.width = pct + '%';
      } else {
        goalFill.style.width = '0%';
      }

      updateChart();
      saveStorage();
    }

    // --- TOGGLE ADD BUTTONS ---
    toggleAddBtn.onclick = () => {
      if (addButtonsDiv.style.display === 'flex') {
        addButtonsDiv.style.display = 'none';
        toggleAddBtn.textContent = 'Meter a la hucha';
      } else {
        addButtonsDiv.style.display = 'flex';
        toggleAddBtn.textContent = 'Cerrar';
      }
    };

    // --- ADD AMOUNTS BUTTONS ---
    addButtonsDiv.querySelectorAll('button[data-amount]').forEach(btn => {
      btn.onclick = () => {
        const amount = parseFloat(btn.getAttribute('data-amount'));
        if (!isNaN(amount) && amount > 0) {
          addAmount(amount);
        }
      };
    });

    addCustomBtn.onclick = () => {
      const val = parseFloat(customInput.value);
      if (!isNaN(val) && val > 0) {
        addAmount(val);
        customInput.value = '';
      }
    };

    function addAmount(amount) {
      total += amount;
      addHistory(`A√±adido ‚Ç¨${amount.toFixed(2)}`);
      playSound();
      updateUI();
    }

    editBtn.onclick = () => {
      const val = prompt('Nuevo total (‚Ç¨):', total);
      const num = parseFloat(val);
      if (!isNaN(num) && num >= 0) {
        total = num;
        addHistory(`Total editado a ‚Ç¨${total.toFixed(2)}`);
        updateUI();
      }
    };

    resetBtn.onclick = () => {
      if (confirm('¬øReiniciar la hucha?')) {
        addHistory(`Hucha reiniciada (antes ‚Ç¨${total.toFixed(2)})`);
        total = 0;
        updateUI();
      }
    };

    goalInput.oninput = () => {
      const val = parseFloat(goalInput.value);
      goal = isNaN(val) ? 0 : val;
      saveGoal();
      updateUI();
    };
    goalName.oninput = () => {
      goalTitle = goalName.value.trim();
      saveGoal();
      updateUI();
    };

    function saveGoal() {
      // Save goal and title also in storage
      saveStorage();
    }

    // --- History management ---
    function addHistory(entry) {
      const now = new Date();
      const timestamp = now.toLocaleString();
      history.unshift(`[${timestamp}] ${entry}`);
      if (history.length > 100) history.pop(); // limit history
      saveStorage();
      if (historyBox.style.display === 'block') renderHistory();
    }

    function renderHistory() {
      historyList.innerHTML = '';
      history.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        historyList.appendChild(li);
      });
    }

    // --- Sound control ---
    function playSound() {
      if (soundMode === 'mute') return;
      if (soundMode === 'sound1') {
        sound1.currentTime = 0;
        sound1.play();
      } else if (soundMode === 'sound2') {
        sound2.currentTime = 0;
        sound2.play();
      }
    }

    // --- Dark mode ---
    function applyDarkMode() {
      if (darkMode) {
        document.body.classList.add('dark');
      } else {
        document.body.classList.remove('dark');
      }
      saveStorage();
    }

    // --- Men√∫s ---
    function toggleSettings() {
      if (settingsMenu.style.display === 'flex') {
        settingsMenu.style.display = 'none';
      } else {
        settingsMenu.style.display = 'flex';
        piggyMenu.style.display = 'none';
        historyBox.style.display = 'none';
        progressChartEl.style.display = 'none';
      }
    }
    function togglePiggyMenu() {
      if (piggyMenu.style.display === 'flex') {
        piggyMenu.style.display = 'none';
      } else {
        piggyMenu.style.display = 'flex';
        settingsMenu.style.display = 'none';
        historyBox.style.display = 'none';
        progressChartEl.style.display = 'none';
      }
    }

    // --- Settings menu buttons ---
    document.getElementById('sound1Btn').onclick = () => {
      soundMode = 'sound1';
      alert('Sonido 1 activado');
      saveStorage();
    };
    document.getElementById('sound2Btn').onclick = () => {
      soundMode = 'sound2';
      alert('Sonido 2 activado');
      saveStorage();
    };
    document.getElementById('muteBtn').onclick = () => {
      soundMode = 'mute';
      alert('Silencio activado');
      saveStorage();
    };
    document.getElementById('toggleDarkModeBtn').onclick = () => {
      darkMode = !darkMode;
      applyDarkMode();
    };
    document.getElementById('viewHistoryBtn').onclick = () => {
      historyBox.style.display = historyBox.style.display === 'block' ? 'none' : 'block';
      settingsMenu.style.display = 'none';
      piggyMenu.style.display = 'none';
      progressChartEl.style.display = 'none';
      if (historyBox.style.display === 'block') renderHistory();
    };
    document.getElementById('viewProgressBtn').onclick = () => {
      progressChartEl.style.display = progressChartEl.style.display === 'block' ? 'none' : 'block';
      settingsMenu.style.display = 'none';
      piggyMenu.style.display = 'none';
      historyBox.style.display = 'none';
    };

    // --- Chart.js Setup ---
    function updateChart() {
      if (!chart) {
        const ctx = progressChartEl.getContext('2d');
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: history.slice(0, 10).map(h => {
              const parts = h.match(/^\[(.+?)\]/);
              return parts ? parts[1].split(',')[0] : '';
            }).reverse(),
            datasets: [{
              label: 'Total ‚Ç¨',
              data: history.slice(0, 10).map(h => {
                const m = h.match(/‚Ç¨(\d+(\.\d+)?)/g);
                if (!m) return null;
                // Take last number in entry as total (edit or reset changes)
                const lastNum = m[m.length -1];
                return parseFloat(lastNum.replace('‚Ç¨','')) || null;
              }).reverse(),
              fill: false,
              borderColor: 'green',
              tension: 0.3,
              pointRadius: 4,
              pointHoverRadius: 6,
            }]
          },
          options: {
            responsive: true,
            animation: { duration: 600 },
            scales: {
              y: {
                beginAtZero: true,
                suggestedMax: goal > 0 ? goal * 1.1 : undefined
              }
            }
          }
        });
      } else {
        // Actualizar datos
        chart.data.labels = history.slice(0, 10).map(h => {
          const parts = h.match(/^\[(.+?)\]/);
          return parts ? parts[1].split(',')[0] : '';
        }).reverse();
        chart.data.datasets[0].data = history.slice(0, 10).map(h => {
          const m = h.match(/‚Ç¨(\d+(\.\d+)?)/g);
          if (!m) return null;
          const lastNum = m[m.length -1];
          return parseFloat(lastNum.replace('‚Ç¨','')) || null;
        }).reverse();
        chart.options.scales.y.suggestedMax = goal > 0 ? goal * 1.1 : undefined;
        chart.update();
      }
    }

    // --- Inicializaci√≥n ---
    loadStorage();
    updateUI();
    applyDarkMode();

    // Cerrar men√∫s si se hace clic fuera
    window.onclick = function(event) {
      if (!event.target.closest('#settingsMenu') && !event.target.closest('.settings-icon')) {
        settingsMenu.style.display = 'none';
      }
      if (!event.target.closest('#piggyMenu') && !event.target.closest('.piggy-menu-icon')) {
        piggyMenu.style.display = 'none';
      }
      if (!event.target.closest('#historyBox') && !event.target.closest('#viewHistoryBtn')) {
        historyBox.style.display = 'none';
      }
      if (!event.target.closest('#progressChart') && !event.target.closest('#viewProgressBtn')) {
        progressChartEl.style.display = 'none';
      }
    };
  </script>
</body>
</html>
