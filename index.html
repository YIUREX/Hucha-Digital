<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hucha Digital Completa</title>
<!-- Fuente Rubik Bold -->
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@700&display=swap" rel="stylesheet" />
<style>
  body {
    margin:0; padding:0;
    font-family: 'Rubik', sans-serif;
    background: white;
    color: black;
    transition: background 0.3s, color 0.3s;
    overflow-x: hidden;
  }
  body.dark {
    background: #121212;
    color: #eee;
  }
  .wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    width: 100%;
    padding: 1rem;
    box-sizing: border-box;
  }
  .goal-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    width: 80%;
    max-width: 320px;
    margin-bottom: 8px;
  }
  .goal-label {
    font-weight: 700;
    font-size: 1.2em;
    user-select: none;
  }
  #goalInput {
    font-size: 1.2em;
    padding: 5px 8px;
    width: 120px;
    border: 2px solid black;
    border-radius: 6px;
    background: transparent;
    color: inherit;
    outline: none;
  }
  #goalInput:focus {
    border-color: green;
  }
  .goal-bar-bg {
    width: 80%;
    max-width: 320px;
    height: 16px;
    background: #ddd;
    border-radius: 12px;
    border: 2px solid black;
    margin: 0 auto 15px;
    overflow: hidden;
  }
  .goal-bar-fill {
    height: 100%;
    background: green;
    width: 0%;
    transition: width 0.6s ease;
  }
  #goalName {
    font-size: 1.5em;
    font-weight: 700;
    border: 2px solid black;
    border-radius: 6px;
    padding: 5px 10px;
    width: 80%;
    max-width: 320px;
    margin-bottom: 5px;
    background: transparent;
    color: inherit;
    outline: none;
    text-align: center;
  }
  #counter {
    font-size: 3em;
    margin-bottom: 15px;
    user-select: none;
  }
  .pig {
    font-size: 6em;
    border: 5px solid black;
    border-radius: 50%;
    padding: 20px;
    margin-bottom: 20px;
    user-select: none;
    color: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #toggleAdd {
    font-weight: 700;
    font-size: 1.2em;
    margin-bottom: 15px;
    padding: 10px 25px;
    border: 2px solid black;
    background: none;
    cursor: pointer;
    color: inherit;
    max-width: 320px;
    transition: background-color 0.3s, color 0.3s;
  }
  #toggleAdd:hover {
    background-color: black;
    color: white;
  }
  #addButtons {
    display: none;
    flex-wrap: wrap;
    justify-content: center;
    gap: 12px;
    max-width: 320px;
    margin-bottom: 15px;
  }
  #addButtons button, #addCustomBtn, #editBtn, #resetBtn {
    padding: 10px 20px;
    font-size: 1em;
    border: 2px solid black;
    background: none;
    cursor: pointer;
    font-weight: 700;
    color: inherit;
    border-radius: 6px;
    transition: background-color 0.3s, color 0.3s;
  }
  #addButtons button:hover, #addCustomBtn:hover, #editBtn:hover, #resetBtn:hover {
    background-color: black;
    color: white;
  }
  #custom {
    padding: 10px;
    font-size: 1em;
    width: 80px;
    text-align: center;
    border: 2px solid black;
    background: transparent;
    color: inherit;
    border-radius: 6px;
  }
  .settings-icon, .piggy-menu-icon {
    position: fixed;
    font-size: 2em;
    cursor: pointer;
    user-select: none;
    color: inherit;
    z-index: 100;
  }
  .settings-icon {
    bottom: 20px;
    right: 20px;
  }
  .piggy-menu-icon {
    top: 20px;
    left: 20px;
  }
  /* Men√∫ ajustes */
  #settingsMenu {
    position: fixed;
    bottom: 70px;
    right: 20px;
    background: white;
    border: 2px solid black;
    padding: 12px;
    display: none;
    flex-direction: column;
    gap: 8px;
    max-width: 280px;
    color: black;
    border-radius: 8px;
    z-index: 110;
  }
  body.dark #settingsMenu {
    background: #222;
    color: white;
    border-color: white;
  }
  #settingsMenu button {
    padding: 6px 10px;
    font-size: 1em;
    cursor: pointer;
    background: none;
    border: 1px solid currentColor;
    color: inherit;
    font-weight: 700;
    border-radius: 6px;
    transition: background-color 0.3s, color 0.3s;
  }
  #settingsMenu button:hover {
    background-color: currentColor;
    color: inherit;
    filter: invert(1);
  }
  #settingsMenu hr {
    border-color: currentColor;
  }
  /* Men√∫ huchas */
  #piggyMenu {
    position: fixed;
    top: 60px;
    left: 20px;
    background: white;
    border: 2px solid black;
    padding: 12px;
    display: none;
    flex-direction: column;
    gap: 8px;
    max-height: 300px;
    overflow-y: auto;
    width: 220px;
    border-radius: 8px;
    color: black;
    z-index: 110;
  }
  body.dark #piggyMenu {
    background: #222;
    color: white;
    border-color: white;
  }
  #piggyMenu button {
    background: none;
    border: 1px solid currentColor;
    padding: 8px;
    cursor: pointer;
    font-weight: 700;
    color: inherit;
    border-radius: 6px;
    transition: background-color 0.3s, color 0.3s;
  }
  #piggyMenu button:hover {
    background-color: currentColor;
    color: inherit;
    filter: invert(1);
  }
  /* Historial */
  #historyBox {
    position: fixed;
    top: 20px;
    right: 20px;
    max-height: 320px;
    width: 280px;
    overflow-y: auto;
    background: rgba(255,255,255,0.95);
    border: 2px solid black;
    padding: 12px;
    font-size: 0.9em;
    display: none;
    border-radius: 8px;
    color: black;
    z-index: 110;
  }
  body.dark #historyBox {
    background: #222;
    color: white;
    border-color: white;
  }
  /* Gr√°fico */
  #progressChart {
    max-width: 90vw;
    max-height: 250px;
    margin: 10px auto 0;
    display: none;
    z-index: 110;
  }
</style>
</head>
<body>

<!-- Iconos flotantes -->
<div class="piggy-menu-icon" title="Men√∫ de huchas" onclick="togglePiggyMenu()">‚ò∞</div>
<div class="settings-icon" title="Ajustes" onclick="toggleSettings()">‚öôÔ∏è</div>

<div class="wrapper">

  <!-- Meta -->
  <div class="goal-container">
    <label for="goalInput" class="goal-label">üéØ Meta (‚Ç¨):</label>
    <input id="goalInput" type="number" min="0" step="0.01" placeholder="Ej: 100" />
  </div>

  <!-- Barra progreso -->
  <div class="goal-bar-bg"><div id="goalFill" class="goal-bar-fill"></div></div>

  <!-- Nombre editable -->
  <input id="goalName" type="text" placeholder="Nombre del ahorro (ej. Viaje)" maxlength="30" />

  <!-- Contador -->
  <div id="counter">‚Ç¨0.00</div>

  <!-- Cerdito -->
  <div class="pig">üê∑</div>

  <!-- Bot√≥n meter -->
  <button id="toggleAdd">Meter a la hucha</button>

  <!-- Botones a√±adir -->
  <div id="addButtons">
    <button data-amount="1">+1‚Ç¨</button>
    <button data-amount="5">+5‚Ç¨</button>
    <button data-amount="10">+10‚Ç¨</button>
    <input id="custom" type="number" placeholder="Otra" min="0.01" step="0.01" />
    <button id="addCustomBtn">A√±adir</button>
    <button id="editBtn">Editar total</button>
    <button id="resetBtn" style="color:red;">Reiniciar</button>
  </div>

</div>

<!-- Men√∫ ajustes -->
<div id="settingsMenu">
  <strong>üéµ Sonido:</strong>
  <button data-sound="coin" onclick="setSound('coin')">Sonido 1</button>
  <button data-sound="bell" onclick="setSound('bell')">Sonido 2</button>
  <button data-sound="none" onclick="setSound('none')">Sin sonido</button>
  <hr/>
  <button id="toggleDarkBtn">Modo Oscuro</button>
  <button id="toggleHistoryBtn">Mostrar Historial</button>
  <button id="toggleChartBtn">Mostrar Gr√°fico</button>
</div>

<!-- Men√∫ huchas -->
<div id="piggyMenu">
  <strong>Huchas:</strong>
  <div id="piggyList"></div>
  <input id="newPiggyName" placeholder="Nueva hucha..." maxlength="20" style="margin-top:6px; padding:6px; border:1px solid currentColor; border-radius:6px; width: 100%; box-sizing: border-box;" />
  <button id="addPiggyBtn" style="margin-top:6px;">A√±adir hucha</button>
</div>

<!-- Historial -->
<div id="historyBox"></div>

<!-- Gr√°fico -->
<canvas id="progressChart"></canvas>

<!-- Sonidos -->
<audio id="soundCoin" src="https://actions.google.com/sounds/v1/coins/coin_drop.ogg" preload="auto"></audio>
<audio id="soundBell" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Variables UI
  const counter = document.getElementById('counter');
  const toggleAddBtn = document.getElementById('toggleAdd');
  const addButtonsDiv = document.getElementById('addButtons');
  const customInput = document.getElementById('custom');
  const addCustomBtn = document.getElementById('addCustomBtn');
  const editBtn = document.getElementById('editBtn');
  const resetBtn = document.getElementById('resetBtn');
  const goalInput = document.getElementById('goalInput');
  const goalFill = document.getElementById('goalFill');
  const goalName = document.getElementById('goalName');

  const piggyMenu = document.getElementById('piggyMenu');
  const piggyList = document.getElementById('piggyList');
  const newPiggyName = document.getElementById('newPiggyName');
  const addPiggyBtn = document.getElementById('addPiggyBtn');

  const settingsMenu = document.getElementById('settingsMenu');
  const toggleDarkBtn = document.getElementById('toggleDarkBtn');
  const toggleHistoryBtn = document.getElementById('toggleHistoryBtn');
  const toggleChartBtn = document.getElementById('toggleChartBtn');

  const historyBox = document.getElementById('historyBox');
  const progressChartCanvas = document.getElementById('progressChart');

  const soundCoin = document.getElementById('soundCoin');
  const soundBell = document.getElementById('soundBell');

  // Estado
  let piggyData = []; // Array de huchas {id, name, total, goal, history:[]}
  let currentPiggyId = null;
  let currentSound = 'coin'; // coin, bell, none

  // Gr√°fico
  let chart = null;

  // LocalStorage helpers
  function saveData() {
    localStorage.setItem('piggyData', JSON.stringify(piggyData));
    localStorage.setItem('currentPiggyId', currentPiggyId);
    localStorage.setItem('currentSound', currentSound);
  }
  function loadData() {
    const data = localStorage.getItem('piggyData');
    piggyData = data ? JSON.parse(data) : [];
    currentPiggyId = localStorage.getItem('currentPiggyId') || (piggyData.length ? piggyData[0].id : null);
    currentSound = localStorage.getItem('currentSound') || 'coin';
  }

  // ID generador simple
  function generateId() {
    return Date.now().toString() + Math.floor(Math.random()*1000);
  }

  // Encontrar hucha actual
  function getCurrentPiggy() {
    return piggyData.find(p => p.id === currentPiggyId);
  }

  // Actualizar UI principal con datos de hucha actual
  function updateUI() {
    const piggy = getCurrentPiggy();
    if (!piggy) {
      counter.textContent = '‚Ç¨0.00';
      goalFill.style.width = '0%';
      goalInput.value = '';
      goalName.value = '';
      return;
    }
    counter.textContent = `‚Ç¨${piggy.total.toFixed(2)}`;
    goalInput.value = piggy.goal || '';
    goalName.value = piggy.name || '';
    if (piggy.goal > 0) {
      const pct = Math.min((piggy.total / piggy.goal)*100, 100);
      goalFill.style.width = pct + '%';
    } else {
      goalFill.style.width = '0%';
    }
  }

  // Mostrar listado huchas en men√∫
  function updatePiggyList() {
    piggyList.innerHTML = '';
    piggyData.forEach(p => {
      const btn = document.createElement('button');
      btn.textContent = p.name || 'Sin nombre';
      if(p.id === currentPiggyId) btn.style.fontWeight = 'bold';
      btn.onclick = () => {
        currentPiggyId = p.id;
        updateUI();
        updatePiggyList();
        hidePiggyMenu();
        hideHistory();
        hideChart();
      };
      piggyList.appendChild(btn);

      // Bot√≥n eliminar
      const delBtn = document.createElement('button');
      delBtn.textContent = 'X';
      delBtn.style.marginLeft = '5px';
      delBtn.style.color = 'red';
      delBtn.onclick = (e) => {
        e.stopPropagation();
        if(confirm(`¬øEliminar hucha "${p.name}"?`)) {
          piggyData = piggyData.filter(x => x.id !== p.id);
          if(currentPiggyId === p.id) currentPiggyId = piggyData.length ? piggyData[0].id : null;
          updatePiggyList();
          updateUI();
          saveData();
          hideHistory();
          hideChart();
        }
      };
      piggyList.appendChild(delBtn);
    });
  }

  // A√±adir nueva hucha
  addPiggyBtn.onclick = () => {
    const name = newPiggyName.value.trim();
    if(!name) {
      alert('Pon un nombre a la nueva hucha');
      return;
    }
    const newPiggy = {
      id: generateId(),
      name,
      total: 0,
      goal: 0,
      history: []
    };
    piggyData.push(newPiggy);
    currentPiggyId = newPiggy.id;
    newPiggyName.value = '';
    updatePiggyList();
    updateUI();
    saveData();
    hideHistory();
    hideChart();
  };

  // A√±adir cantidad al total y guardar en historial
  function addAmount(amount) {
    const piggy = getCurrentPiggy();
    if(!piggy) return;
    piggy.total += amount;
    piggy.history.push({ date: Date.now(), amount });
    playSound();
    updateUI();
    saveData();
    if(historyVisible) updateHistory();
    if(chartVisible) updateChart();
  }

  // Editar total (con historial)
  function editTotal(newTotal) {
    const piggy = getCurrentPiggy();
    if(!piggy) return;
    const diff = newTotal - piggy.total;
    piggy.total = newTotal;
    piggy.history.push({ date: Date.now(), amount: diff });
    updateUI();
    saveData();
    if(historyVisible) updateHistory();
    if(chartVisible) updateChart();
  }

  // Reiniciar hucha (con confirm y historial)
  function resetPiggy() {
    const piggy = getCurrentPiggy();
    if(!piggy) return;
    if(confirm('¬øReiniciar la hucha?')) {
      const diff = -piggy.total;
      piggy.total = 0;
      piggy.history.push({ date: Date.now(), amount: diff });
      updateUI();
      saveData();
      if(historyVisible) updateHistory();
      if(chartVisible) updateChart();
    }
  }

  // Eventos botones a√±adir
  toggleAddBtn.onclick = () => {
    if(addButtonsDiv.style.display === 'flex') {
      addButtonsDiv.style.display = 'none';
      toggleAddBtn.textContent = 'Meter a la hucha';
    } else {
      addButtonsDiv.style.display = 'flex';
      toggleAddBtn.textContent = 'Cerrar';
    }
  };

  document.querySelectorAll('#addButtons button[data-amount]').forEach(btn => {
    btn.onclick = () => {
      const amount = parseFloat(btn.getAttribute('data-amount'));
      if(!isNaN(amount)) {
        addAmount(amount);
      }
    };
  });

  addCustomBtn.onclick = () => {
    const val = parseFloat(customInput.value);
    if(!isNaN(val) && val > 0) {
      addAmount(val);
      customInput.value = '';
    }
  };

  editBtn.onclick = () => {
    const val = prompt('Nuevo total (‚Ç¨):', getCurrentPiggy()?.total || 0);
    const num = parseFloat(val);
    if(!isNaN(num) && num >= 0) {
      editTotal(num);
    }
  };

  resetBtn.onclick = () => {
    resetPiggy();
  };

  // Inputs meta y nombre guardan directo
  goalInput.oninput = () => {
    const piggy = getCurrentPiggy();
    if(!piggy) return;
    const val = parseFloat(goalInput.value);
    piggy.goal = isNaN(val) ? 0 : val;
    updateUI();
    saveData();
  };

  goalName.oninput = () => {
    const piggy = getCurrentPiggy();
    if(!piggy) return;
    piggy.name = goalName.value;
    updatePiggyList();
    saveData();
  };

  // Sonidos
  function playSound() {
    if(currentSound === 'none') return;
    if(currentSound === 'coin') {
      soundCoin.currentTime = 0;
      soundCoin.play().catch(()=>{});
    }
    if(currentSound === 'bell') {
      soundBell.currentTime = 0;
      soundBell.play().catch(()=>{});
    }
  }
  function setSound(sound) {
    currentSound = sound;
    saveData();
  }

  // Modo oscuro
  function toggleDark() {
    document.body.classList.toggle('dark');
    saveData();
  }
  toggleDarkBtn.onclick = () => {
    toggleDark();
  };

  // Historial
  let historyVisible = false;
  function updateHistory() {
    const piggy = getCurrentPiggy();
    if(!piggy) {
      historyBox.innerHTML = '';
      return;
    }
    if(piggy.history.length === 0) {
      historyBox.innerHTML = '<em>No hay historial</em>';
      return;
    }
    let html = '<strong>Historial:</strong><br>';
    piggy.history.slice().reverse().forEach(h => {
      const d = new Date(h.date);
      const sign = h.amount > 0 ? '+' : '';
      html += `<div>${d.toLocaleString()}: ${sign}${h.amount.toFixed(2)} ‚Ç¨</div>`;
    });
    historyBox.innerHTML = html;
  }
  toggleHistoryBtn.onclick = () => {
    historyVisible = !historyVisible;
    historyBox.style.display = historyVisible ? 'block' : 'none';
    if(historyVisible) updateHistory();
  };
  function hideHistory() {
    historyVisible = false;
    historyBox.style.display = 'none';
  }

  // Gr√°fico
  let chartVisible = false;
  function updateChart() {
    const piggy = getCurrentPiggy();
    if(!piggy) return;
    const sortedHistory = piggy.history.slice().sort((a,b) => a.date - b.date);
    const labels = [];
    const data = [];
    let acc = 0;
    sortedHistory.forEach(h => {
      acc += h.amount;
      labels.push(new Date(h.date).toLocaleDateString());
      data.push(acc.toFixed(2));
    });
    if(chart) chart.destroy();
    chart = new Chart(progressChartCanvas, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Progreso ‚Ç¨',
          data,
          fill: false,
          borderColor: 'green',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
  toggleChartBtn.onclick = () => {
    chartVisible = !chartVisible;
    progressChartCanvas.style.display = chartVisible ? 'block' : 'none';
    if(chartVisible) updateChart();
  };
  function hideChart() {
    chartVisible = false;
    progressChartCanvas.style.display = 'none';
    if(chart) {
      chart.destroy();
      chart = null;
    }
  }

  // Mostrar/ocultar men√∫s
  function toggleSettings() {
    if(settingsMenu.style.display === 'flex') {
      settingsMenu.style.display = 'none';
    } else {
      settingsMenu.style.display = 'flex';
      piggyMenu.style.display = 'none';
      hideHistory();
      hideChart();
    }
  }
  function togglePiggyMenu() {
    if(piggyMenu.style.display === 'flex') {
      piggyMenu.style.display = 'none';
    } else {
      piggyMenu.style.display = 'flex';
      settingsMenu.style.display = 'none';
      hideHistory();
      hideChart();
    }
  }
  function hidePiggyMenu() {
    piggyMenu.style.display = 'none';
  }

  // Inicializar
  function init() {
    loadData();
    if(!piggyData.length) {
      // Crear una hucha inicial si no hay ninguna
      const initPiggy = { id: generateId(), name: 'Mi hucha', total: 0, goal: 0, history: [] };
      piggyData.push(initPiggy);
      currentPiggyId = initPiggy.id;
      saveData();
    }
    // Restaurar modo oscuro
    if(localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
    }
    updatePiggyList();
    updateUI();
  }
  init();
</script>

</body>
</html>
